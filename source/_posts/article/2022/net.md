---
title: 再谈“三次握手”和“四次挥手”
date: 2022-03-08
tags:
  - 计算机网络
categories: 计算机网络
cover: https://cdn.jsdelivr.net/gh/maya1900/pic@master/img/202203201346696.jpg
---

## TCP报文格式

![](https://cdn.jsdelivr.net/gh/maya1900/pic@master/img/202203201401374.png)

其中重要字段：

* 序号(sequence number)：seq序号，4个字节。在一个TCP连接中传送的字节流的每一个字节都按顺序编号，seq是本报文段的第一个字节的序号
* 确认号(acknowledgement number)：ack序号，4个字节。期望收到对方下一个报文段的第一个数据字节的序号，对方报文段最后一个字节序号加1
* 标志位(flags)：0或1
  * 确认(ACK)：ACK=1时确认号才有效；
  * 同步(SYN)：SYN=1表示这是一个连接请求或连接接受报文
  * 终止(FIN)：FIN释放连接，FIN=1表明数据发送完毕，要求释放运输连接

## 三次握手

![](https://cdn.jsdelivr.net/gh/maya1900/pic@master/img/202203201426392.gif)

1. 客户端向服务器发送报文，标志位为SYN，序号seq=x，客户端进入syn-sent状态；
2. 服务器收到并返回报文，标志位SYN和ACK，序号seq=y，确认号ack=x+1，服务器进入syn-rcvd状态；
3. 客户端收到并返回报文，标志位ACK，序号seq=x+1即服务器的ack，确认号ack=y+1，客户端进入established状态，服务器收到报文后也进入established状态。

## 四次挥手

![](https://cdn.jsdelivr.net/gh/maya1900/pic@master/img/202203201441531.gif)

1. 客户端向服务器发送报文，标志位FIN，序号seq=u，客户端进入fin-wait-1状态；
2. 服务器收到报文进入close-wait状态并返回报文，标志位ACK，序号seq=y，确认号ack=u+1；客户端收到报文进入fin-wait-2状态；
3. 服务器做好了释放准备发送报文，标志位FIN和ACK，序号seq=w，确认号ack=u+1，服务器进入last-ack状态；
4. 客户端收到报文进入time-wait状态并返回报文，标志位ACK，序号seq=u+1，确认号ack=w+1，客户端随后等待2MSL；服务器收到报文进入closed状态，客户端等待完2MSL后进入closed状态

## 为什么是3次握手不是2次或4次？

2次的问题：A向B发送请求报文，B收到回复A确认报文，但B无法确定A是否收到报文，A也无法确定B是否收到请求报文(B的确认报文可能丢失)，造成死锁，；

4次问题：A向B发送请求报文，B回复A确认报文，B再向A发送请求报文，A向B发送确认报文，其中2、3步可以合并提高连接速度

## 3次握手中途请求失败怎么办？

- 第一次发送SYN给服务器失败
  - 客户端会周期性重传，直到服务器收到
- 第二次发送SYN+ACK失败
  - 服务器会周期性重传，直到客户端确认
- 第三次发送ACK失败
  - 客户端单方面认为连接成功，此时：
    - a. 如果一直没有数据发送，服务器会周期性重传SYN+ACK，直到客户端发送ACK成功(TCP不会为没有数据的ACK超时重传)
    - b. 如果客户端有数据发送，服务器收到data+ACK，自然会切换到连接状态，接受客户端的data
    - c. 如果服务器有数据发送，数据发送不了(因为服务器状态还不是连接成功状态)，服务器会周期性重传SYN+ACK，直到客户端确认。

## 为什么tcp连接的时候是三次，断开的时候却是四次？

因为在连接的时候，服务器收到客户端的SYN请求时，可以直接发送SYN+ACK，ACK用来应答的，SYN用来同步的；
但是在断开时，服务器收到客户端的FIN请求时，可能服务器还没向客户端发送完数据，只能先发送个ACK，表示知道了，等服务器所有报文都发送完了，再向客户端发送FIN+ACK，表示可以结束了

## 为什么客户端在结束后还要等2MSL(最大报文段生存时间)才能到closed状态？

客户端需要判断最后的一个ACK服务器是否成功接收，2MSL就是一个发送和一个回复所需的最大时间，如果最后的ACK丢失，服务器会向客户端继续发送FIN+ACK报文，客户端重发ACK并再次等待2MSL，如果直到2MSL，客户端都没有收到FIN，客户顿则认为服务器已经收到ACK，则结束TCP连接。

## 如果已经建立连接，客户端发生故障怎么办？

TCP设有一个保活计时器，时间通常是2个小时，如果2小时内都没有收到客户端的任何数据，服务器会发送一个探测报文段，以后每隔75s发送一次，连发10次仍然没有回应，服务器认为客户端故障，则断开连接。

## ISN是什么？

initial sequence number，初始序列号。发送方的字节数据编号的原点

## 握手的第三次可以携带数据吗？

可以。能够发出第三次握手的用户应该是合法的用户，尽管服务器的状态还不是established，但在收到第三次握手瞬间状态变为成功，数据可以成功接收。

## ACK标志位可以单独承担消息传递的任务吗？

不行！需要ack number配合，如果成功接收ack number，则表明前面发送的数据已经被成功接收。
